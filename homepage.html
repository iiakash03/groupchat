<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <button onclick="location.href='../addgroup.html'" id="fp">Create Group</button>
    <div class="container">
    <header style="color: purple;" class="header" align="middle"><h1>CHAT APP</h1></header>
    </div>
    <div>
        <ul id="groups">
            GROUPS 

        </ul>
    </div>
    <div>
        <table class="table" align="center">
            <thead>
                <tr>
                    <th scope="col">Messages</th>
                </tr>
            </thead>
            <tbody id="ul">
            </tbody>
        </table>
    </div>
    <div>
    <footer class="footer">
        <form onsubmit="messagesend()" id="messageform">
            <input type="text" id="message">
            <input type="submit" value="Send">
        </form>

    </footer>
    </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        let gid=0

        const token=localStorage.getItem('token')
        function messagesend(e){

            event.preventDefault();
            const message=document.getElementById("message").value;
            document.getElementById("message").value="";
            //const token=localStorage.getItem('token');
            document.getElementById('')

            const obj={
                message,
                token,
                gid
            }
            const size=localStorage.getItem('message')
            if(!size){
                localStorage.setItem('message',message)
            }

            axios.post('http://localhost:3000/message/savemessage',obj,{headers:{Authorization:token}})
            .then(result=>{
                console.log("done")
            }
                
            )
        }
        
            function selectedGroup(id){
                gid=id
                localStorage.setItem('groupid',gid);

                axios.post('http://localhost:3000/group/admincontrol',{gid},{headers:{Authorization:token}})
                .then(result=>{
                    console.log(result.data[0].isAdmin)
                    if(result.data[0].isAdmin===true){
                        console.log('fdrtfr')
                        let addbuttons=document.getElementById(gid)
                        addbuttons.innerHTML+=`<button onclick=location.href='../editgroup.html'>Add/Remove User</button>`
                        addbuttons.innerHTML+=`<button onclick=location.href='../admingroup.html'>Add/Remove Admin</button>`

                    }
                    

                })

                axios.get(`http://localhost:3000/message/getGroupMessage?groupid=${id}`)
                .then(messages=>{
                    console.log(messages,"hghgvhjvkhbjhub")
                    document.getElementById('ul').innerText=''
                    showMessageOnScreen(messages.data)

                })
            }

        window.addEventListener("DOMContentLoaded",()=>{
            const token=localStorage.getItem("token");
            //console.log(token)
            //setInterval(()=>{
                let arr=[];
                obj={

                }
                axios.post('http://localhost:3000/group/getgroup',obj,{headers:{Authorization:token}})
                .then(groups=>{
                    if(groups.data.length==0){
                        const input=document.getElementById('messageform').style.visibility='hidden'
                    }
                    showContentOnScreen(groups.data)
                })

                document.getElementById('ul').innerText="";
                //showMessageOnScreen(localStorage.getItem('message'))
            
           // },100000000)
        
        })

        function showContentOnScreen(obj){
            console.log(obj[0])
            let groups=document.getElementById('groups')
            for(let i=0;i<obj.length;i++){
                groups.innerHTML+=`<li><button id="${obj[i].id}" onClick=selectedGroup('${obj[i].id}')>${obj[i].groupname}</button></li>`
            }

        }

 function showMessageOnScreen(obj) {
    console.log(obj)
    const messages = Array.isArray(obj) ? obj : obj.split(",");
    if (messages.length === 0) {
        return;
    }
    console.log(messages)

    const messageHtml = messages.map((message) =>`<tr><td>${message.message}</td></tr>`).join("");
    document.getElementById("ul").innerHTML = messageHtml;
  }

    </script>

    
</body>
</html>